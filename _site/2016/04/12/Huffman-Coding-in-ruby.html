<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Joshua Washke</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/css/bootstrap.min.css" integrity="sha384-y3tfxAZXuh4HwSYylfB+J125MxIs6mR5FOHamPBG064zB+AFeWH94NdvaCBm8qnd" crossorigin="anonymous">
    <link rel='shortcut icon' href='assets/favicon.ico' type='image/x-icon'/ >
    <link href="/assets/style.css" rel="stylesheet">
    <link href="/assets/syntax.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Merriweather:400,700,400italic' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Noto+Sans:400,700' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>
  </head>
  <body>

        <div class="container">
          <div class="header clearfix">
            <nav>
              <ul class="nav nav-pills pull-xs-right">
                <li class="nav-item">
                  <a class="nav-link" href="/blog">Blog</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="/portfolio">Portfolio</a>
                </li>
                <li class="nav-item">
                  <a class="nav-link" href="https://github.com/jwashke">Github</a>
                </li>
              </ul>
            </nav>
            <a class="brand-link" href="/"><h3 class="">JW</h3></a>
          </div>


<h1>Huffman Coding in Ruby</h1>
<p>April 12, 2016</p>
<p>Theres a lot of technologies that seem like just magic to me. I know they’re not magic,
but I just assume its thing handled by people far smarter than me.
Compression was always one of those things to me. Compression tools like 7zip take a file, and magically makes it smaller.
I’m a student at the Turing School of Software and Design, and recently someone asked me to build a very simple compression
tool using ruby. While building the tool I had to learn how compression actually works, or at least the basics of it.</p>

<p>The compression tool I built uses Huffman coding, a technique created by David Huffman in 1952. In normal text, each character is stored
as a single byte of 8 bits, which gives 256 possible combinations. Including letters, numbers, and special characters, you can only type 95 characters on a standard keyboard.
The basics of Huffman coding is that you reassign the number of bits required to represent each character, based on the frequency of the character in the message.
The huffman coding implementation I built was a simple ruby script, that took in a string message and output a shortened bitstring of the message.</p>

<p>The first step was to get the message, and get a count of all the characters in the message.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="c1"># build a hash where each character is a key, while the value is the number of times that character appears in the message</span>
  <span class="k">def</span> <span class="nf">character_counts</span>
    <span class="n">count</span> <span class="o">=</span> <span class="no">Hash</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="vi">@message</span><span class="p">.</span><span class="nf">chars</span><span class="p">.</span><span class="nf">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span>
      <span class="n">count</span><span class="p">[</span><span class="n">char</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="n">count</span>
  <span class="k">end</span></code></pre></figure>

<p>The next step is to create a priority queue of the characters as nodes to be stored in a trie</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">priority_queue</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">character_counts</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span> <span class="no">Node</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span></code></pre></figure>

<p>Then sort the queue based on the frequency of the characters so that the lowest appearing characters have the highest priority</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">sort_queue</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
    <span class="n">queue</span><span class="p">.</span><span class="nf">sort_by</span> <span class="p">{</span> <span class="o">|</span><span class="n">node</span><span class="o">|</span> <span class="n">node</span><span class="p">.</span><span class="nf">number</span> <span class="p">}</span>
  <span class="k">end</span></code></pre></figure>

<p>While there is more than one node in the queue:
Remove the two nodes of highest priority (lowest probability) from the queue
Create a new internal node with these two nodes as children and with probability equal to the sum of the two nodes’ probabilities.
Add the new node to the queue.
Build the tree with by removing the two highest priority nodes from the queue, creating a new internal node with those two nodes as its children, and its frequency equal to the sum of its children. Then add the new node to the queue. Repeat
this process until there is only 1 node left in the queue.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">build_tree</span>
    <span class="n">queue</span> <span class="o">=</span> <span class="n">priority_queue</span>
    <span class="k">until</span> <span class="n">queue</span><span class="p">.</span><span class="nf">size</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="n">queue</span> <span class="o">=</span> <span class="n">sort_queue</span><span class="p">(</span><span class="n">queue</span><span class="p">)</span>
      <span class="c1"># remove the two nodes with the highest priority</span>
      <span class="n">node1</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="nf">shift</span>
      <span class="n">node2</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="nf">shift</span>
      <span class="c1"># create a new internal node with these two nodes as children and with</span>
      <span class="c1"># probability equal to the sum of the two nodes probablities</span>
      <span class="n">node3</span> <span class="o">=</span> <span class="no">Node</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">node1</span><span class="p">.</span><span class="nf">string</span> <span class="o">+</span> <span class="n">node2</span><span class="p">.</span><span class="nf">string</span><span class="p">,</span>
                       <span class="n">node1</span><span class="p">.</span><span class="nf">number</span> <span class="o">+</span> <span class="n">node2</span><span class="p">.</span><span class="nf">number</span><span class="p">)</span>
      <span class="n">node3</span><span class="p">.</span><span class="nf">left</span>  <span class="o">=</span> <span class="n">node1</span>
      <span class="n">node3</span><span class="p">.</span><span class="nf">right</span> <span class="o">=</span> <span class="n">node2</span>
      <span class="c1"># add this new node to the queue,</span>
      <span class="n">queue</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="n">node3</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="vi">@root_node</span> <span class="o">=</span> <span class="n">queue</span><span class="p">.</span><span class="nf">first</span>
    <span class="c1"># the last node is the root node and the tree is complete</span>
    <span class="c1"># now count the number of nodes and leaf nodes</span>
    <span class="s2">"Tree made with </span><span class="si">#{</span><span class="n">count_nodes</span><span class="p">(</span><span class="vi">@root_node</span><span class="p">)</span><span class="si">}</span><span class="s2"> total nodes and </span><span class="si">#{</span><span class="n">count_leaves</span><span class="p">(</span><span class="vi">@root_node</span><span class="p">)</span><span class="si">}</span><span class="s2"> leaf nodes"</span>
  <span class="k">end</span></code></pre></figure>

<p>Wikipedia has a good visual representation of the process
<img src="https://upload.wikimedia.org/wikipedia/commons/a/ac/Huffman_huff_demo.gif" alt="Huffman" /></p>

<p>Finally, encoding the message is just mapping through the message, changing each character into its new bitstring form.
You encode each character by traversing down the tree, starting at the root node, until you find that characters leaf. Everytime you traverse to the left, you add a 0, every time you traverse right you add a 1. the string of 0s and 1s you get at the end is your new encoded bitstring for the character.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="k">def</span> <span class="nf">coded_array</span>
    <span class="vi">@message</span><span class="p">.</span><span class="nf">chars</span><span class="p">.</span><span class="nf">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">char</span><span class="o">|</span> <span class="n">char_to_code</span><span class="p">(</span><span class="n">char</span><span class="p">)</span> <span class="p">}</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">char_to_code</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">node</span> <span class="o">=</span> <span class="vi">@root_node</span><span class="p">)</span>
    <span class="n">bytes</span> <span class="o">=</span> <span class="s2">""</span>
    <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="nf">left</span> <span class="o">!=</span> <span class="kp">nil</span> <span class="n">and</span> <span class="n">node</span><span class="p">.</span><span class="nf">left</span><span class="p">.</span><span class="nf">string</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="s2">"0"</span> <span class="o">+</span> <span class="n">char_to_code</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="nf">left</span><span class="p">)</span>
    <span class="k">elsif</span> <span class="n">node</span><span class="p">.</span><span class="nf">right</span> <span class="o">!=</span> <span class="kp">nil</span> <span class="n">and</span> <span class="n">node</span><span class="p">.</span><span class="nf">right</span><span class="p">.</span><span class="nf">string</span><span class="p">.</span><span class="nf">include?</span><span class="p">(</span><span class="n">char</span><span class="p">)</span>
        <span class="n">bytes</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">+</span> <span class="n">char_to_code</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="nf">right</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="n">bytes</span>
  <span class="k">end</span></code></pre></figure>

<p>With this we can take a message</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mo">00</span><span class="mi">8</span> <span class="o">&gt;</span> <span class="n">encoder</span><span class="p">.</span><span class="nf">message</span>
 <span class="o">=&gt;</span> <span class="s2">"Thats not moon, thats a space station"</span></code></pre></figure>

<p>And encode to a smaller bitstream form</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mo">014</span> <span class="o">&gt;</span> <span class="n">encoder</span><span class="p">.</span><span class="nf">build_tree</span>
<span class="o">=&gt;</span> <span class="s2">"Tree made with 27 total nodes and 14 leaf nodes"</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mo">015</span> <span class="o">&gt;</span> <span class="n">encoder</span><span class="p">.</span><span class="nf">coded_array</span><span class="p">.</span><span class="nf">join</span>
<span class="o">=&gt;</span> <span class="s2">"001100010100111011110000010111110001110100100001011111101110010100111011110100110011101110100101101010011001111110011110101010000"</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mo">016</span> <span class="o">&gt;</span> <span class="n">encoder</span><span class="p">.</span><span class="nf">original_bitlength</span>
<span class="o">=&gt;</span> <span class="mi">296</span>
<span class="mi">2</span><span class="o">.</span><span class="mi">3</span><span class="o">.</span><span class="mi">0</span> <span class="p">:</span><span class="mo">017</span> <span class="o">&gt;</span> <span class="n">encoder</span><span class="p">.</span><span class="nf">coded_bitlength</span>
<span class="o">=&gt;</span> <span class="mi">129</span></code></pre></figure>

<p>To decompress the message. You need to reconstruct the tree, and run through the process in reverse.</p>

<p>The amazing thing about learning programming is the more I learn the more it dispels the notion of technology as magic, at least as magic
insofar as that its for people far smarter than me. I used think I could learn to build some cool stuff. Now I believe I can learn to build anything
given enough time and motivation.</p>



      <footer class="footer">
      <p class="footer-links">
        <a href="https://github.com/jwashke"><i class="fa fa-github fa-2x fa-fw"></i></a>
        <a href="https://medium.com/@jwashke"><i class="fa fa-medium fa-2x fa-fw"></i></a>
        <a href="mailto:jwashke@icloud.com"><i class="fa fa-envelope-o fa-2x fa-fw"></i></a>
        <a href="https://www.linkedin.com/in/joshua-washke-251381102"><i class="fa fa-linkedin fa-2x fa-fw"></i></a>
      </p>
      </footer>
        </div>
        <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-78786642-1', 'auto');
  ga('send', 'pageview');

</script>
      <!--
  --><!-- jQuery first, then Bootstrap JS. --><script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script><script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.2/js/bootstrap.min.js" integrity="sha384-vZ2WRJMwsjRMW/8U7i6PWi6AlO1L79snBrmgiDpgIWJ82z8eA5lenwvxbMV1PAh7" crossorigin="anonymous"></script><script src="https://use.fontawesome.com/7a30fd75bb.js"></script>
  </body>
</html>

